commit 3fcd2aaf81e54db339a96b31c3b6b5d01f1c2ae4
Author: vagrant <vagrant@kubm1>
Date:   Mon Aug 11 05:21:55 2025 +0000

    avant 3eme install Vagrant

diff --git a/.gitignore b/.gitignore
index 059acbe..8ddc725 100644
--- a/.gitignore
+++ b/.gitignore
@@ -1,3 +1,4 @@
 .vagrant/
 .vagrant/
 .DS_Store
+nudger-infra/k8s-ansible/collections/ansible_collections
diff --git a/nudger-infra/k8s-ansible/ansible.cfg b/nudger-infra/k8s-ansible/ansible.cfg
index c8407b6..d092d29 100644
--- a/nudger-infra/k8s-ansible/ansible.cfg
+++ b/nudger-infra/k8s-ansible/ansible.cfg
@@ -12,7 +12,7 @@ stdout_callback = ansible.builtin.default
 result_format = yaml
 # DÃ©sactiver explicitement l'ancien systÃ¨me
 bin_ansible_callbacks = False
-collections_paths = /home/vagrant/.ansible/collections:/usr/share/ansible/collections
+collections_paths = ./collections:/home/vagrant/.ansible/collections:/usr/share/ansible/collections
 interpreter_python = /usr/bin/python3
 
 [ssh_connection]
diff --git a/nudger-infra/k8s-ansible/collections/requirements.yml b/nudger-infra/k8s-ansible/collections/requirements.yml
new file mode 100644
index 0000000..c3f0488
--- /dev/null
+++ b/nudger-infra/k8s-ansible/collections/requirements.yml
@@ -0,0 +1,5 @@
+collections:
+  - name: community.general
+    version: 5.8.0
+  - name: ansible.posix
+    version: 1.4.0
diff --git a/nudger-infra/k8s-ansible/k8s-ansible.md b/nudger-infra/k8s-ansible/k8s-ansible.md
index 9495ee7..d3a038e 100644
--- a/nudger-infra/k8s-ansible/k8s-ansible.md
+++ b/nudger-infra/k8s-ansible/k8s-ansible.md
@@ -17,4 +17,8 @@ ansible-galaxy collection install community.general
 
 ansible all -m file -a "path=/root/.ansible/tmp state=directory mode=0775 owner=root group=root" -b
 
+============
+git
+
+ansible-galaxy collection install community.general
 
diff --git a/nudger-infra/k8s-ansible/roles/containerd/tasks/main.yml b/nudger-infra/k8s-ansible/roles/containerd/tasks/main.yml
index 2080979..c800ace 100644
--- a/nudger-infra/k8s-ansible/roles/containerd/tasks/main.yml
+++ b/nudger-infra/k8s-ansible/roles/containerd/tasks/main.yml
@@ -114,13 +114,6 @@
     daemon_reload: yes
   tags: containerd_install
 
-- name: Start and enable containerd
-  systemd:
-    name: containerd
-    state: started
-    enabled: yes
-  tags: containerd_install
-
 - name: Configurer containerd avec template
   template:
     src: config.toml.j2
@@ -131,6 +124,13 @@
   notify: Restart containerd
   tags: containerd_config
 
+- name: Start and enable containerd
+  systemd:
+    name: containerd
+    state: started
+    enabled: yes
+  tags: containerd_install
+
 - name: TÃ©lÃ©charger crictl binaire
   get_url:
     url: https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.28.0/crictl-v1.28.0-linux-amd64.tar.gz
@@ -165,6 +165,16 @@
   when: inventory_hostname == groups['k8s_masters'][0]
   register: kubeadm_init
   notify:
-    - save kubeconfig
+    - Save kubeconfig file
     - configure kubectl
   tags: kubernetes_init
+
+- name: Copy admin.conf to user's kube config
+  copy:
+    src: /etc/kubernetes/admin.conf
+    dest: "/home/{{ ansible_user }}/.kube/config"
+    owner: "{{ ansible_user }}"
+    group: "{{ ansible_user }}"
+    mode: '0600'
+    remote_src: yes
+  become: yes
diff --git a/nudger-infra/k8s-ansible/roles/docker/vars/main.yml b/nudger-infra/k8s-ansible/roles/docker/vars/main.yml
index cb800cd..40ebfd1 100644
--- a/nudger-infra/k8s-ansible/roles/docker/vars/main.yml
+++ b/nudger-infra/k8s-ansible/roles/docker/vars/main.yml
@@ -9,7 +9,7 @@ docker_dependencies:
 docker_gpg_url: "https://download.docker.com/linux/ubuntu/gpg"
 docker_gpg_path: "/etc/apt/keyrings/docker.gpg"
 docker_repo_url: "https://download.docker.com/linux/ubuntu"
-docker_repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
+docker_repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
 docker_packages:
   - docker-ce
   - docker-ce-cli
diff --git a/nudger-infra/k8s-ansible/roles/kubernetes/tasks/main.yml b/nudger-infra/k8s-ansible/roles/kubernetes/tasks/main.yml
index 51029af..d630719 100644
--- a/nudger-infra/k8s-ansible/roles/kubernetes/tasks/main.yml
+++ b/nudger-infra/k8s-ansible/roles/kubernetes/tasks/main.yml
@@ -80,14 +80,3 @@
     mode: '0700'
     owner: "{{ ansible_user }}"
     group: "{{ ansible_user }}"
-
-- name: Copy admin.conf to user's kube config
-  copy:
-    src: /etc/kubernetes/admin.conf
-    dest: "/home/{{ ansible_user }}/.kube/config"
-    owner: "{{ ansible_user }}"
-    group: "{{ ansible_user }}"
-    mode: '0600'
-    remote_src: yes
-  become: yes
-
diff --git a/vagrant/Vagrantfile b/vagrant/Vagrantfile
index c7bd154..60bc34d 100644
--- a/vagrant/Vagrantfile
+++ b/vagrant/Vagrantfile
@@ -40,70 +40,9 @@ Vagrant.configure("2") do |config|
         qemu.cpu = "max"
         qemu.net_device = "virtio-net-pci"
       end
-
-      # Provision de base (packages utiles)
-      vm.vm.provision "shell", inline: common_provision
-
-      # Ajout de la clÃ© SSH de l'utilisateur Ã  root + vagrant
-      vm.vm.provision "shell" do |s|
-        ssh_pub_key = File.read("#{Dir.home}/.ssh/id_rsa.pub").strip
-        s.inline = <<-SHELL
-          mkdir -p /root/.ssh /home/vagrant/.ssh
-          echo "#{ssh_pub_key}" >> /root/.ssh/authorized_keys
-          echo "#{ssh_pub_key}" >> /home/vagrant/.ssh/authorized_keys
-          chown vagrant:vagrant /home/vagrant/.ssh/authorized_keys
-        SHELL
-      end
-
-      # Ajout de toutes les entrÃ©es /etc/hosts pour la rÃ©solution entre nodes
-      vm.vm.provision "shell", inline: <<-SHELL
-        echo "#{hosts_entries}" | tee -a /etc/hosts > /dev/null
-      SHELL
+      # Passer les entrÃ©es /etc/hosts au script
+      vm.vm.provision "shell", env: { "HOSTS_ENTRIES" => hosts_entries }, path: "scripts/setup-ssh.sh"
+      vm.vm.provision "shell", path: "scripts/install-ansible.sh"
     end
   end
-
-  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
-  # ðŸ§± Brique 1 : Mise Ã  jour systÃ¨me
-  config.vm.provision "shell", name: "update_system", inline: <<~SHELL
-    echo "[1/6] Mise Ã  jour du systÃ¨me"
-    sudo apt-get update -qq
-    sudo apt-get upgrade -yq
-  SHELL
-
-  # ðŸ§± Brique 2 : Installation des dÃ©pendances systÃ¨me
-  config.vm.provision "shell", name: "install_base_dependencies", inline: <<~SHELL
-    echo "[2/6] Installation des paquets de base"
-    sudo DEBIAN_FRONTEND=noninteractive apt-get install -yq \
-      python3-pip \
-      python3-venv \
-      git \
-      sshpass \
-      libssl-dev \
-      libffi-dev
-  SHELL
-
-  # ðŸ§± Brique 3 : CrÃ©ation de lâ€™environnement Python dÃ©diÃ© Ã  Ansible
-  config.vm.provision "shell", name: "create_ansible_venv", inline: <<~SHELL
-    echo "[3/6] CrÃ©ation de l'environnement virtuel Ansible"
-    sudo python3 -m venv /opt/ansible_venv
-    sudo /opt/ansible_venv/bin/pip install --upgrade pip wheel
-  SHELL
-
-  # ðŸ§± Brique 4 : Installation d'Ansible et outils
-  config.vm.provision "shell", name: "install_ansible_stack", inline: <<~SHELL
-    echo "[4/6] Installation d'Ansible et des outils"
-    sudo /opt/ansible_venv/bin/pip install \
-      ansible-core==2.15.3 \
-      ansible-lint==6.22.1 \
-      molecule==5.1.0 \
-      passlib
-  SHELL
-
-  # ðŸ§± Brique 5 : Configuration globale Ansible
-  config.vm.provision "shell", name: "setup_ansible_cfg", inline: <<~SHELL
-    echo "[5/6] Configuration Ansible"
-    sudo mkdir -p /etc/ansible
-    echo -e "[defaults]\ninterpreter_python = /opt/ansible_venv/bin/python3\nhost_key_checking = False" | sudo tee /etc/ansible/ansible.cfg > /dev/null
-    sudo ln -sf /opt/ansible_venv/bin/ansible* /usr/local/bin/
-  SHELL
 end
diff --git a/vagrant/scripts/install-ansible.sh b/vagrant/scripts/install-ansible.sh
new file mode 100755
index 0000000..da9230b
--- /dev/null
+++ b/vagrant/scripts/install-ansible.sh
@@ -0,0 +1,42 @@
+#!/bin/bash
+set -euo pipefail
+
+echo "[ANSIBLE-INSTALL] Installation d'Ansible et dÃ©pendances"
+
+# Mise Ã  jour du systÃ¨me
+sudo apt-get update -qq
+sudo apt-get upgrade -yq
+
+# Paquets de base
+sudo DEBIAN_FRONTEND=noninteractive apt-get install -yq \
+    unzip iftop curl software-properties-common git vim tree net-tools telnet \
+    python3-pip python3-venv sshpass libssl-dev libffi-dev
+
+# CrÃ©ation d'un environnement Python dÃ©diÃ© pour Ansible si absent
+if [ ! -d "/opt/ansible_venv" ]; then
+    echo "[ANSIBLE-INSTALL] CrÃ©ation de l'environnement virtuel..."
+    sudo python3 -m venv /opt/ansible_venv
+    sudo /opt/ansible_venv/bin/pip install --upgrade pip wheel
+fi
+
+# Installation d'Ansible + outils dans le venv
+sudo /opt/ansible_venv/bin/pip install \
+    ansible-core==2.15.3 \
+    ansible-lint==6.22.1 \
+    molecule==5.1.0 \
+    passlib
+
+# Configuration globale d'Ansible
+sudo mkdir -p /etc/ansible
+echo -e "[defaults]\ninterpreter_python = /opt/ansible_venv/bin/python3\nhost_key_checking = False" \
+    | sudo tee /etc/ansible/ansible.cfg >/dev/null
+
+# Liens symboliques pour accÃ¨s direct Ã  ansible depuis le PATH
+sudo ln -sf /opt/ansible_venv/bin/ansible* /usr/local/bin/
+
+# Installation de collections Ansible utiles
+sudo /opt/ansible_venv/bin/ansible-galaxy collection install \
+    community.general ansible.posix --force
+
+echo "[ANSIBLE-INSTALL] TerminÃ©."
+
diff --git a/vagrant/scripts/setup-lab.sh b/vagrant/scripts/setup-lab.sh
new file mode 100755
index 0000000..ac04182
--- /dev/null
+++ b/vagrant/scripts/setup-lab.sh
@@ -0,0 +1,32 @@
+#!/bin/bash
+set -e
+
+### Variables ###
+PLAYBOOK_REPO="https://github.com/monuser/mon-playbook.git" # <-- Ã  modifier
+PLAYBOOK_DIR="$HOME/k8s-ansible"
+PLAYBOOK_BRANCH="main"  # ou un tag: v1.2.0
+
+echo "ðŸš€ [1/5] Mise Ã  jour des paquets..."
+sudo apt-get update -y
+
+echo "ðŸ“¦ [2/5] Installation dÃ©pendances..."
+sudo apt-get install -y git ansible vagrant virtualbox
+
+echo "ðŸ“¥ [3/5] RÃ©cupÃ©ration du playbook..."
+if [ ! -d "$PLAYBOOK_DIR" ]; then
+    git clone --branch "$PLAYBOOK_BRANCH" --depth 1 "$PLAYBOOK_REPO" "$PLAYBOOK_DIR"
+else
+    echo "ðŸ”„ Playbook dÃ©jÃ  prÃ©sent, mise Ã  jour..."
+    git -C "$PLAYBOOK_DIR" fetch origin
+    git -C "$PLAYBOOK_DIR" reset --hard "origin/$PLAYBOOK_BRANCH"
+fi
+
+echo "ðŸ’» [4/5] DÃ©marrage des VM Vagrant..."
+vagrant up --provision
+
+echo "ðŸ›  [5/5] Lancement du playbook Kubernetes..."
+cd "$PLAYBOOK_DIR"
+ansible-playbook -i inventory.ini setup.yml
+
+echo "âœ… Lab Kubernetes prÃªt Ã  lâ€™emploi !"
+
diff --git a/vagrant/scripts/setup-ssh.sh b/vagrant/scripts/setup-ssh.sh
new file mode 100755
index 0000000..9cb41c7
--- /dev/null
+++ b/vagrant/scripts/setup-ssh.sh
@@ -0,0 +1,45 @@
+#!/bin/bash
+set -euo pipefail
+
+echo "[SETUP-SSH] Configuration des clÃ©s SSH et de l'accÃ¨s"
+
+USER_HOME="/home/vagrant"
+SSH_DIR="$USER_HOME/.ssh"
+PUB_KEY_PATH="$SSH_DIR/id_rsa.pub"
+AUTH_KEYS="$SSH_DIR/authorized_keys"
+
+# CrÃ©ation du dossier .ssh
+mkdir -p "$SSH_DIR"
+chmod 700 "$SSH_DIR"
+chown vagrant:vagrant "$SSH_DIR"
+
+# GÃ©nÃ©ration de clÃ© si absente
+if [ ! -f "$PUB_KEY_PATH" ]; then
+    echo "[SETUP-SSH] GÃ©nÃ©ration de la clÃ© SSH..."
+    ssh-keygen -t rsa -b 4096 -f "$SSH_DIR/id_rsa" -N "" >/dev/null
+    chown vagrant:vagrant "$SSH_DIR/id_rsa" "$PUB_KEY_PATH"
+fi
+
+# Ajout de la clÃ© publique Ã  authorized_keys si pas dÃ©jÃ  prÃ©sente
+if ! grep -q "$(cat "$PUB_KEY_PATH")" "$AUTH_KEYS" 2>/dev/null; then
+    cat "$PUB_KEY_PATH" >> "$AUTH_KEYS"
+    chmod 600 "$AUTH_KEYS"
+    chown vagrant:vagrant "$AUTH_KEYS"
+    echo "[SETUP-SSH] ClÃ© ajoutÃ©e Ã  authorized_keys"
+fi
+
+# DÃ©sactivation du mot de passe pour SSH
+sudo sed -i 's/^#\?PasswordAuthentication .*/PasswordAuthentication no/' /etc/ssh/sshd_config
+sudo sed -i 's/^#\?ChallengeResponseAuthentication .*/ChallengeResponseAuthentication yes/' /etc/ssh/sshd_config
+sudo systemctl restart sshd
+
+# Ajout des entrÃ©es /etc/hosts si non prÃ©sentes
+if [ -n "${HOSTS_ENTRIES:-}" ]; then
+    echo "[SETUP-SSH] Mise Ã  jour de /etc/hosts"
+    while read -r entry; do
+        grep -qF "$entry" /etc/hosts || echo "$entry" | sudo tee -a /etc/hosts >/dev/null
+    done <<< "$HOSTS_ENTRIES"
+fi
+
+echo "[SETUP-SSH] TerminÃ©."
+
