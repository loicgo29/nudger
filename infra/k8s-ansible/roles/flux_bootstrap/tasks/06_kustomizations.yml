---
- name: Ensure per-env Kustomizations exist
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition:
      apiVersion: kustomize.toolkit.fluxcd.io/v1
      kind: Kustomization
      metadata:
        name: "{{ item }}-root"
        namespace: "{{ flux_namespace }}"
      spec:
        interval: "{{ kustomize_interval }}"
        sourceRef: { kind: GitRepository, name: gitops }
        path: "./gitops/clusters/{{ item }}"
        prune: true
        wait: false
  loop: "{{ gitops_envs }}"
  loop_control: { label: "{{ item }}" }

