---
# Expect the calling play to set: become: true
# Variables expected (can live in vars/defaults):
# - ansible_venv
# - user_home
# - bin_dir

# ========== Base packages & user env ==========
- name: Ensure python3-venv is installed (with retry)
  ansible.builtin.apt:
    name: python3-venv
    state: present
    update_cache: yes
  register: apt_result
  retries: 5
  delay: 10
  until: apt_result is succeeded
  tags: [packages]

- name: Install base system packages
  ansible.builtin.apt:
    name:
      - zsh
      - git
      - curl
      - wget
      - jq
      - tree
      - unzip
      - bash-completion
      - make
      - tar
      - gzip
    state: present
    update_cache: yes
  tags: [packages]

- name: Ensure user bin directory exists
  ansible.builtin.file:
    path: "{{ bin_dir }}"
    state: directory
    mode: '0755'
    owner: "{{ ansible_user_id | default(lookup('env','USER')) }}"
  tags: [user-env]


# ========== Ansible virtualenv ==========
# Rationale: we enforce idempotence with `creates:` and remove a broken venv if activate is missing.

- name: Check if the Ansible virtualenv exists
  ansible.builtin.stat:
    path: "{{ ansible_venv }}/bin/activate"
  register: venv_stat
  tags: [venv]

- name: Remove the venv if incomplete
  ansible.builtin.file:
    path: "{{ ansible_venv }}"
    state: absent
  when: not venv_stat.stat.exists
  tags: [venv]

- name: Create the Ansible virtualenv (idempotent via creates)
  ansible.builtin.command: python3 -m venv "{{ ansible_venv }}"
  args:
    creates: "{{ ansible_venv }}/bin/activate"
  tags: [venv]

- name: Upgrade pip inside the venv
  ansible.builtin.pip:
    name: pip
    state: latest
    virtualenv: "{{ ansible_venv }}"
    virtualenv_command: "python3 -m venv"
  tags: [venv]

- name: Install Python packages in the venv
  ansible.builtin.pip:
    name:
      - "ansible-core>=2.16,<2.18"
      - ansible-lint
      - openshift
      - kubernetes
      - pyyaml
      - passlib
    virtualenv: "{{ ansible_venv }}"
    virtualenv_command: "python3 -m venv"
  tags: [venv]


# roles/devops/tasks/fzf.yml
- name: Install fzf under /opt/fzf if missing
  become: true
  block:
    - git:
        repo: https://github.com/junegunn/fzf.git
        dest: /opt/fzf
        version: master
        update: yes
    - command: ./install --bin
      args:
        chdir: /opt/fzf
        creates: /opt/fzf/bin/fzf

