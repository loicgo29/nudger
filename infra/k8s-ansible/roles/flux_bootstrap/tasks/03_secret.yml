---
- name: Assert auth config
  ansible.builtin.assert:
    that:
      - git_auth_mode in ['pat','ssh']
    fail_msg: "git_auth_mode doit Ãªtre 'pat' ou 'ssh'"

# --- PAT mode ---
- name: Assert PAT provided
  ansible.builtin.assert:
    that:
      - (github_pat | length) >= 20
    fail_msg: "github_pat absent/trop court. Renseigne vault_github_pat ou surcharge github_pat."
  when: git_auth_mode == 'pat'

- name: Ensure git secret (HTTPS PAT)
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "{{ git_secret_name }}"
        namespace: "{{ flux_namespace }}"
      type: Opaque
      stringData:
        username: "git"
        password: "{{ github_pat }}"
  no_log: true
  when: git_auth_mode == 'pat'

# --- SSH mode ---
- name: Read SSH private key (controller)
  ansible.builtin.set_fact:
    _ssh_priv: "{{ lookup('ansible.builtin.file', ssh_key_private_path) }}"
    _ssh_pub:  "{{ lookup('ansible.builtin.file', ssh_key_public_path) }}"
    _known_hosts: "{{ lookup('ansible.builtin.pipe', 'ssh-keyscan -t rsa github.com 2>/dev/null') }}"
  run_once: true
  delegate_to: localhost
  when: git_auth_mode == 'ssh'

- name: Ensure git secret (SSH)
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "{{ git_secret_name }}"
        namespace: "{{ flux_namespace }}"
      type: Opaque
      stringData:
        identity: "{{ _ssh_priv }}"
        identity.pub: "{{ _ssh_pub }}"
        known_hosts: "{{ _known_hosts }}"
  no_log: true
  when: git_auth_mode == 'ssh'

